user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    server {
        listen 8000;
        server_name _;

        # Git HTTP backend - simplified regex
        location ~ ^/(.+)/(HEAD|info/refs|objects/.*|git-upload-pack|git-receive-pack)$ {
            # Set git repository root
            fastcgi_param GIT_PROJECT_ROOT /git-repos;
            fastcgi_param GIT_HTTP_EXPORT_ALL "";
            fastcgi_param PATH_INFO /$1/$2;
            
            # Standard FastCGI parameters
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME /usr/libexec/git-core/git-http-backend;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            
            # Pass to fcgiwrap
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
        }

        # Serve git objects directly (optimization) - simplified
        location ~ ^/(.+)/objects/(.+)/(.+)$ {
            alias /git-repos/$1/.git/objects/$2/$3;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 '{"status":"healthy"}';
            add_header Content-Type application/json;
        }

        # Repository listing endpoint
        location = /repositories {
            default_type application/json;
            # This is a simple static response - ideally you'd generate this dynamically
            return 200 '{"repositories":[{"name":"base-math","url":"http://git-server:8000/base-math"},{"name":"algebra-theorems","url":"http://git-server:8000/algebra-theorems"},{"name":"advanced-proofs","url":"http://git-server:8000/advanced-proofs"}]}';
        }
    }
}
