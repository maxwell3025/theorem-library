# This file is auto-generated by scripts/generate_compose.py
# Do not edit this file directly.
# Any changes should be made to common/config.py, and this file should be generated by running:
#   python scripts/generate_compose.py

name: theorem-library
networks:
  theorem-library: null
services:
  dependency-service:
    build:
      additional_contexts:
      - common=./common
      context: ./dependency-service
      dockerfile: Dockerfile
    container_name: dependency-service
    depends_on:
      neo4j:
        condition: service_healthy
    environment:
    - NEO4J_USER=${NEO4J_USER}
    - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - httpx
      - http://localhost:8000/health
      timeout: 1s
    networks:
    - theorem-library
    ports:
    - 8001:8000
    restart: unless-stopped
  dependency-worker:
    build:
      additional_contexts:
      - common=./common
      context: ./dependency-service
      dockerfile: Dockerfile
    command:
    - celery
    - --app
    - main_celery
    - worker
    - --loglevel=info
    - -Q
    - dependency
    container_name: dependency-worker
    depends_on:
      neo4j:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
    - NEO4J_USER=${NEO4J_USER}
    - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - celery
      - --app
      - main_celery
      - inspect
      - ping
      timeout: 2s
    networks:
    - theorem-library
    ports:
    - 8012:8000
    restart: unless-stopped
  git-server:
    build:
      additional_contexts: []
      context: ./git-server
      dockerfile: Dockerfile
    container_name: git-server
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://127.0.0.1:8000/health
      timeout: 1s
    networks:
    - theorem-library
    ports:
    - 8005:8000
    restart: unless-stopped
  latex-service:
    build:
      additional_contexts:
      - common=./common
      context: ./latex-service
      dockerfile: Dockerfile
    command:
    - python
    - main.py
    container_name: latex-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      verification-redis:
        condition: service_healthy
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - httpx
      - http://localhost:8000/health
      timeout: 1s
    networks:
    - theorem-library
    ports:
    - 8004:8000
    restart: unless-stopped
  latex-task:
    build:
      additional_contexts:
      - common=./common
      context: ./latex-task
      dockerfile: Dockerfile
    deploy:
      replicas: 0
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - httpx
      - http://localhost:8000/health
      timeout: 1s
    networks:
    - theorem-library
    restart: unless-stopped
  latex-worker:
    build:
      additional_contexts:
      - common=./common
      context: ./latex-service
      dockerfile: Dockerfile
    command:
    - celery
    - --app
    - main_celery
    - worker
    - --loglevel=info
    - -Q
    - latex
    container_name: latex-worker
    depends_on:
      rabbitmq:
        condition: service_healthy
      verification-redis:
        condition: service_healthy
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - celery
      - --app
      - main_celery
      - inspect
      - ping
      timeout: 2s
    networks:
    - theorem-library
    ports:
    - 8013:8000
    restart: unless-stopped
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
  neo4j:
    container_name: neo4j
    environment:
    - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
    - NEO4J_server_memory_heap_initial__size=512m
    - NEO4J_server_memory_heap_max__size=2G
    healthcheck:
      interval: 5s
      retries: 5.0
      start_period: 1s
      test:
      - CMD
      - cypher-shell
      - -u
      - neo4j
      - -p
      - ${NEO4J_PASSWORD}
      - RETURN 1
      timeout: 3s
    image: neo4j:5
    networks:
    - theorem-library
    ports:
    - 8011:7474
    - 8010:7687
    restart: unless-stopped
    volumes:
    - neo4j_data:/data
    - neo4j_logs:/logs
  nginx:
    depends_on:
      dependency-service:
        condition: service_healthy
      latex-service:
        condition: service_healthy
      pdf-service:
        condition: service_healthy
      verification-service:
        condition: service_healthy
    image: nginx:latest
    networks:
    - theorem-library
    ports:
    - 80:80
    restart: unless-stopped
    volumes:
    - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
  pdf-service:
    build:
      additional_contexts:
      - common=./common
      context: ./pdf-service
      dockerfile: Dockerfile
    container_name: pdf-service
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - httpx
      - http://localhost:8000/health
      timeout: 1s
    networks:
    - theorem-library
    ports:
    - 8003:8000
    restart: unless-stopped
    volumes:
    - pdf_data:/data
  rabbitmq:
    container_name: rabbitmq
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - rabbitmq-diagnostics
      - -q
      - ping
      timeout: 1s
    image: rabbitmq:4-management
    networks:
    - theorem-library
    ports:
    - 8006:5672
    - 8007:15672
    restart: unless-stopped
    volumes:
    - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
  verification-redis:
    container_name: verification-redis
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - redis-cli
      - ping
      timeout: 1s
    image: redis:7-alpine
    networks:
    - theorem-library
    ports:
    - 8009:6379
    restart: unless-stopped
  verification-service:
    build:
      additional_contexts:
      - common=./common
      context: ./verification-service
      dockerfile: Dockerfile
    command:
    - python
    - main_fastapi.py
    container_name: verification-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      verification-redis:
        condition: service_healthy
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - httpx
      - http://localhost:8000/health
      timeout: 1s
    networks:
    - theorem-library
    ports:
    - 8002:8000
    restart: unless-stopped
  verification-task:
    build:
      additional_contexts:
      - common=./common
      context: ./verification-task
      dockerfile: Dockerfile
    deploy:
      replicas: 0
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - httpx
      - http://localhost:8000/health
      timeout: 1s
    networks:
    - theorem-library
    restart: unless-stopped
  verification-worker:
    build:
      additional_contexts:
      - common=./common
      context: ./verification-service
      dockerfile: Dockerfile
    command:
    - celery
    - --app
    - main_celery
    - worker
    - --loglevel=info
    - -Q
    - verification
    container_name: verification-worker
    depends_on:
      rabbitmq:
        condition: service_healthy
      verification-redis:
        condition: service_healthy
    healthcheck:
      interval: 1s
      retries: 10
      start_period: 1s
      test:
      - CMD
      - celery
      - --app
      - main_celery
      - inspect
      - ping
      timeout: 2s
    networks:
    - theorem-library
    ports:
    - 8008:8000
    restart: unless-stopped
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
volumes:
  neo4j_data: null
  neo4j_logs: null
  pdf_data: null
